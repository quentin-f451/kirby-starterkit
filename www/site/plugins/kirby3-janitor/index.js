!function(){"use strict";function t(t,e,s,o,i,n,a,r){var l,d="function"==typeof t?t.options:t;if(e&&(d.render=e,d.staticRenderFns=s,d._compiled=!0),o&&(d.functional=!0),n&&(d._scopeId="data-v-"+n),a?(l=function(t){(t=t||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(t=__VUE_SSR_CONTEXT__),i&&i.call(this,t),t&&t._registeredComponents&&t._registeredComponents.add(a)},d._ssrRegister=l):i&&(l=r?function(){i.call(this,(d.functional?this.parent:this).$root.$options.shadowRoot)}:i),l)if(d.functional){d._injectStyles=l;var c=d.render;d.render=function(t,e){return l.call(e),c(t,e)}}else{var u=d.beforeCreate;d.beforeCreate=u?[].concat(u,l):[l]}return{exports:t,options:d}}const e={name:"Janitor",props:{label:String,progress:String,job:String,cooldown:Number,status:String,data:String,pageURI:String,clipboard:Boolean,unsaved:Boolean,autosave:Boolean,intab:Boolean,confirm:String,icon:[Boolean,String]},data:()=>({oldlabel:"",downloadRequest:"",clipboardRequest:"",urlRequest:"",confirm:""}),created(){this.$events.$on("model.update",this.modelHasUpdate),this.clickAfterAutosave()},computed:{id:function(){return"janitor-"+this.hashCode(this.job+this.label+this.pageURI)},pageHasChanges:function(){return this.$store.getters["content/hasChanges"]()},currentIcon:function(){return this.status?"doing-job"==this.status?"janitorLoader":"is-success"==this.status?"check":"has-error"==this.status?"alert":void 0:this.icon}},methods:{hashCode(t){let e=0;if(0==t.length)return e;for(let s=0;s<t.length;s++){e=(e<<5)-e+t.charCodeAt(s),e&=e}return e},modelHasUpdate(){sessionStorage.getItem("clickAfterAutosave")&&location.reload()},clickAfterAutosave(){let t=sessionStorage.getItem("clickAfterAutosave");null!=t&&t==this.id&&(sessionStorage.removeItem("clickAfterAutosave"),this.janitor())},janitor(){if(""!==this.confirm&&!window.confirm(this.confirm))return;if(!0===this.autosave&&this.pageHasChanges){const t=document.querySelector("div.k-panel nav.k-form-buttons div.k-view").lastChild;if(void 0!==t)return this.unsaved=!1,sessionStorage.setItem("clickAfterAutosave",this.id),void this.simulateClick(t)}if(!0===this.clipboard){this.clipboardRequest=this.data,this.oldlabel=this.label,this.label=this.progress,this.status="is-success";let t=this;return setTimeout((function(){t.label=t.oldlabel,t.status=""}),this.cooldown),void this.$nextTick((function(){t.copyToClipboard(t.$refs.clipboard)}))}if(""!==this.clipboardRequest)return this.copyToClipboard(this.$refs.clipboard),this.label=this.oldlabel,this.status="",void(this.clipboardRequest="");if(void 0!==this.status&&""!==this.status)return;let t=this.job;if(t=t+"/"+encodeURIComponent(this.pageURI),null!=this.data){let e=this.data;t=t+"/"+encodeURIComponent(e)}this.getRequest(t)},getRequest(t){let e=this;this.oldlabel=this.label,this.label=null!=this.progress&&this.progress.length>0?this.progress:this.label+"...",this.status="doing-job",this.$api.get(t).then((t=>{if(void 0!==t.label&&(e.label=t.label),void 0!==t.status?e.status=200==t.status?"is-success":"has-error":e.status="has-response",void 0!==t.reload&&!0===t.reload&&location.reload(),void 0!==t.href)if(this.intab){this.urlRequest=t.href;let e=this;this.$nextTick((function(){e.simulateClick(e.$refs.openintab)}))}else location.href=t.href;if(void 0!==t.download){this.downloadRequest=t.download;let e=this;this.$nextTick((function(){e.simulateClick(e.$refs.download)}))}void 0!==t.clipboard?this.clipboardRequest=t.clipboard:setTimeout((function(){e.label=e.oldlabel,e.status=""}),e.cooldown)}))},simulateClick(t){let e=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window});t.dispatchEvent(e)},copyToClipboard(t){var e,s,o,i,n,a,r;r="_hiddenCopyText_",i=void 0,o=void 0,(s="INPUT"===t.tagName||"TEXTAREA"===t.tagName)?(a=t,i=t.selectionStart,o=t.selectionEnd):((a=document.getElementById(r))||((a=document.createElement("textarea")).style.position="absolute",a.style.left="-9999px",a.style.top="0",a.id=r,document.body.appendChild(a)),a.textContent=t.textContent),e=document.activeElement,a.focus(),a.setSelectionRange(0,a.value.length),n=void 0;try{n=document.execCommand("copy")}catch(l){n=!1}return e&&"function"==typeof e.focus&&e.focus(),s?t.setSelectionRange(i,o):a.textContent="",n}}},s={};var o=t(e,(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"janitor-wrapper"},[s("k-button",{staticClass:"janitor",class:t.status,attrs:{id:t.id,icon:t.currentIcon,job:t.job,disabled:!this.unsaved&&this.pageHasChanges},on:{click:function(e){return t.janitor()}}},[t._v(t._s(t.label)+" ")]),s("a",{ref:"download",staticClass:"hidden",attrs:{href:t.downloadRequest,download:""}}),s("a",{ref:"openintab",staticClass:"hidden",attrs:{href:t.urlRequest,target:"_blank"}}),s("textarea",{ref:"clipboard",staticClass:"hidden"},[t._v(t._s(t.clipboardRequest))])],1)}),[],!1,i,null,null,null);function i(t){for(let e in s)this[e]=s[e]}var n=function(){return o.exports}();panel.plugin("bnomei/janitor",{fields:{janitor:n},icons:{janitorLoader:'<g fill="none" fill-rule="evenodd"><g transform="translate(1 1)" stroke-width="1.75"><circle cx="7" cy="7" r="7.2" stroke="#000" stroke-opacity=".2"/><path d="M14.2,7c0-4-3.2-7.2-7.2-7.2" stroke="#000"><animateTransform attributeName="transform" type="rotate" from="0 7 7" to="360 7 7" dur="1s" repeatCount="indefinite"/></path></g></g>'}})}();
